<% layout('../layout') -%>

<script src="/bower_components/jQuery.ajaxRetry/src/jQuery.ajaxRetry.js"></script>
<script>
var outbound_api = new OutboundApi(purecloud_session);
var contactlist  = null;
var contacts     = [];

if (contactlist == null)
{
  console.log('Loading ContactList <%= contactlist_id %>');
  outbound_api.getContactlist('<%= contactlist_id %>', true, true, true)
    .done(view_contacts)
    .fail(function(error){ console.error(error); });
}
else
{
 // view_contact(contactlist);
}

function view_contacts(data)
{
  contactlist = data;
  console.log("Displaying Contacts in ContactList ", data.id);
  console.dir(data);

  render_template(data, 'contacts_view', 'contacts_template');
  max_tries = 5;
  for (contact_id=1; contact_id <= data.size; contact_id++)
  {
    $('#contacts_view table tbody:last-child')
      .append('<tr id= "contact_view_' + contact_id + '"><td>' + contact_id + '</td></tr>');

    //outbound_api.getContactlistContact(contactlist.id, contact_id)
    $.ajax({
      method: 'GET',
      url: 'https://api.mypurecloud.<%= settings.purecloud_region %>/api/v1/outbound/contactlists/' + contactlist.id + '/contacts/' + contact_id,
      headers: {
        'Accept': 'application/json',
        'Content-Type': 'application/json',
      },
      beforeSend: function(xhr) { xhr.setRequestHeader('Authorization', 'bearer <%= token %>'); },
      timeout: 5000,
      shouldRetry: 5,
    }).done(view_contact)
      .fail(function(jqXHR, status){
          console.error("Error %s to fetch contact %s", status, contact_id);
          console.dir(jqXHR);
      });
  }
}

function view_contact(data)
{
  console.log("Displaying Contact ", data.id);
  console.dir(data);

  $('#contact_view_' + data.id)
    .append($('<td>').text(data.data.Email))
    .append($('<td>')
      .append($('<a>')
        .attr('href', '/Contacts/' + data.id + '/?contactlist_id=' + data.contactListId)
        .text('view')
      )
      .append(' | ')
      .append($('<a>')
        .attr('href', '/Contacts/' + data.id + '/edit?contactlist_id=' + data.contactListId)
        .text('edit')
      )
      .append(' | ')
      .append($('<a>')
        .attr('id', 'contact_delete_' + data.id)
        .attr('href', '#')
        .text('delete')
      )
    );
  $('#contact_delete_' + data.id).on('click', null, data.id, on_click_delete);
}

function on_click_delete(event)
{
  console.log("Delete Click Event!");

  // Prevent link from firing up
  event.preventDefault();
  console.dir(event);

  console.log("deleting contact: %s", event.data);
}

</script>

<script id="contacts_template" type="text/template">
<h4><span class="badge">{{size}}</span> Contacts in ContactList {{name}}</h4>
<table class="table">
  <thead>
  <tr><th>id</th><th>Email</th><th&nbsp;</th>
  </thead>
  <tbody></tbody>
</table>
</div>

<script id="contact_template" type="text/template">
  <td>{{id}}</td>
  <td>{{data.email}}</td>
  <td><a href="/Contacts/{{id}}/edit?contactlist_id={{contactListId}}">edit</a></td>
  <td>delete</td>
      <!-- <input type="submit" value="Create" class="btn btn-default on_click_create"/> -->
      <!-- <a  href="#" class="btn btn-primary on_click_create">Create!</a> -->
</div>

</script>

<h2>Index</h2>
<hr/>
<div id="contacts_view"></div>


<div>
  <a href="/ContactLists/<%= contactlist_id %>">Back to List</a>

