#!/usr/bin/env node

/**
 * Module dependencies.
 */

var package_info = require('../package.json');
var fs = require('fs');
var config = require('nconf');
var app = require('../app');
var debug = require('debug')('DialerPureCloudAPIDemo:server');
var http = require('http');
var gitrev = require('git-rev');

// Retrieve the configuration
//  Order: CLI, Environment, config file, defaults.
config.argv({
  'purecloud:regions': {
    alias: 'regions',
    describe: 'Available regions'
  },
  'purecloud:organizations': {
    alias: [ 'organizations', 'orgs' ],
    describe: 'The Organizations to connect to'
  },
  'port': {
    alias: 'p',
    describe: 'Make the server listen to this port'
  }
})
.env({
  separator: '_',
  lowerCase: true
})
.file({ file: 'config.json' })
.defaults({
  port: 3000,
  purecloud: {
    regions: [
      { id: 'au', name: 'Australia', suffix: 'com.au' },
      { id: 'ie', name: 'Ireland',   suffix: 'ie' },
      { id: 'jp', name: 'Japan',     suffix: 'jp' },
      { id: 'us', name: 'US',        suffix: 'com' }
    ],
    "organizations": [
    ]
  }
});

/**
 * Get port and store in Express.
 */

var port = normalizePort(config.get('port'));
app.set('port', port);
console.log('Listening on port: ' + port);

/**
 * Get PureCloud Region and store in Express.
 */
var regions = config.get('purecloud:regions');

console.log("Loaded regions: ", regions);
if (!(regions instanceof Array)) {
  regions = JSON.parse(regions);
  console.log("Parsed regions: ", regions);
}
app.set('purecloud_regions', regions);

/**
 * Get PureCloud Applications and store them in Express.
 */
var organizations = config.get('purecloud:organizations');

console.log("Loaded organizations: ", organizations);
if (!(organizations instanceof Array)) {
  organizations = JSON.parse(organizations);
  console.log("Parsed organizations: ", organizations);
}
organizations.forEach(function(organization){
  organization['region'] = regions.find(function(region) { return region.id === organization.region_id; });
});
app.set('organizations', organizations);
console.log("Updated organizations: ", organizations);

/**
 * Environment and git information
 */


console.log("Environment: %s", app.get('env'));
console.log("Version: %s", package_info.version);
gitrev.short(function(value)  { console.log('Git commit: ' + value); });
gitrev.branch(function(value) { console.log('Git branch: ' + value); });
gitrev.tag(function(value)    { console.log('Git tag: '    + value); });

/**
 * Create HTTP server.
 */

var server = http.createServer(app);

/**
 * Listen on provided port, on all network interfaces.
 */

server.listen(port);
server.on('error', onError);
server.on('listening', onListening);

/**
 * Normalize a port into a number, string, or false.
 */

function normalizePort(val) {
  var port = parseInt(val, 10);

  if (isNaN(port)) {
    // named pipe
    return val;
  }

  if (port >= 0) {
    // port number
    return port;
  }

  return false;
}

/**
 * Event listener for HTTP server "error" event.
 */

function onError(error) {
  if (error.syscall !== 'listen') {
    throw error;
  }

  var bind = typeof port === 'string'
    ? 'Pipe ' + port
    : 'Port ' + port;

  // handle specific listen errors with friendly messages
  switch (error.code) {
    case 'EACCES':
      console.error(bind + ' requires elevated privileges');
      process.exit(1);
      break;
    case 'EADDRINUSE':
      console.error(bind + ' is already in use');
      process.exit(1);
      break;
    default:
      throw error;
  }
}

/**
 * Event listener for HTTP server "listening" event.
 */

function onListening() {
  var addr = server.address();
  var bind = typeof addr === 'string'
    ? 'pipe ' + addr
    : 'port ' + addr.port;
  debug('Listening on ' + bind);
}
