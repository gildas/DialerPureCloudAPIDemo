#!/usr/bin/env node

/**
 * Module dependencies.
 */

var package_info = require('../package.json');
var fs = require('fs');
var config = require('nconf');
var app = require('../app');
var debug = require('debug')('DialerPureCloudAPIDemo:server');
var http = require('http');
var gitrev = require('git-rev');

// Retrieve the configuration
//  Order: CLI, Environment, config file, defaults.
config.argv({
  'purecloud:region': {
    alias: 'region',
    describe: 'To connect to PureCloud in a given region (EU, EMEA, APAC, AU, JP, US)'
  },
  'purecloud:application': {
    alias: [ 'application', 'application_id', 'app_id', 'client_id', 'id' ],
    describe: 'The Application ID to be sent to PureCloud OAUTH'
  },
  'port': {
    alias: 'p',
    describe: 'Make the server listen to this port'
  }
})
.env({
  separator: '_',
  lowerCase: true
})
.file({ file: 'config.json' })
.defaults({
  port: 3000,
  purecloud: {
    region: 'US',
    application: 'PLEASE PROVIDE'
  }
});

console.log("Version: %s", package_info.version);
gitrev.short(function(value)  { console.log('Git commit: ' + value); });
gitrev.branch(function(value) { console.log('Git branch: ' + value); });
gitrev.tag(function(value)    { console.log('Git tag: '    + value); });

/**
 * Get port and store in Express.
 */

var port = normalizePort(config.get('port'));
app.set('port', port);
console.log('Listening on port: ' + port);

/**
 * Get PureCloud Application Id and store in Express.
 */

app.set('application_id', config.get('purecloud:application'));
console.log('Using PureCloud Client ID: ' + app.get('application_id'));

/**
 * Get PureCloud Region and store in Express.
 */
var regions        = { APAC: 'com.au', AU: 'com.au', EMEA: 'ie', EU: 'ie', IE: 'ie', JP: 'jp', US: 'com' };
var region_default = 'US';
var region_name    = config.get('purecloud:region').toUpperCase();

app.set('purecloud_region', regions[region_name] ? regions[region_name] : regions[region_default]);
console.log('Will connect to: mypurecloud.' + app.get('purecloud_region') + ' (' + region_name + ')');

/**
 * Create HTTP server.
 */

var server = http.createServer(app);

/**
 * Listen on provided port, on all network interfaces.
 */

server.listen(port);
server.on('error', onError);
server.on('listening', onListening);

/**
 * Normalize a port into a number, string, or false.
 */

function normalizePort(val) {
  var port = parseInt(val, 10);

  if (isNaN(port)) {
    // named pipe
    return val;
  }

  if (port >= 0) {
    // port number
    return port;
  }

  return false;
}

/**
 * Event listener for HTTP server "error" event.
 */

function onError(error) {
  if (error.syscall !== 'listen') {
    throw error;
  }

  var bind = typeof port === 'string'
    ? 'Pipe ' + port
    : 'Port ' + port;

  // handle specific listen errors with friendly messages
  switch (error.code) {
    case 'EACCES':
      console.error(bind + ' requires elevated privileges');
      process.exit(1);
      break;
    case 'EADDRINUSE':
      console.error(bind + ' is already in use');
      process.exit(1);
      break;
    default:
      throw error;
  }
}

/**
 * Event listener for HTTP server "listening" event.
 */

function onListening() {
  var addr = server.address();
  var bind = typeof addr === 'string'
    ? 'pipe ' + addr
    : 'port ' + addr.port;
  debug('Listening on ' + bind);
}
